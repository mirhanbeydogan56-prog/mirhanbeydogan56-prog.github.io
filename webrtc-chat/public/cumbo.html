<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Şifreli WebRTC Video Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        video {
            border: 2px solid black;
            margin: 10px;
            max-width: 100%;
        }

        #localVideo {
            width: 45%;
        }

        #remoteVideo {
            width: 45%;
        }

        #passwordScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #passwordInput {
            padding: 10px;
            font-size: 16px;
            margin-right: 10px;
        }

        #passwordButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

    </style>
</head>
<body>

<div id="passwordScreen">
    <input type="password" id="passwordInput" placeholder="Şifreyi girin..." />
    <button id="passwordButton" onclick="checkPassword()">Giriş Yap</button>
</div>

<h1>WebRTC Video Chat</h1>

<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>

<button id="callButton" onclick="startCall()" disabled>Start Call</button>

<script>
    let localStream;
    let remoteStream;
    let peerConnection;
    let socket;
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const passwordScreen = document.getElementById('passwordScreen');

    const configuration = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' }
        ]
    };

    // WebSocket bağlantısı (Port 3000'de)
    socket = new WebSocket('ws://localhost:3000');  // Port 3000'e güncellendi

    socket.onopen = () => {
        console.log('WebSocket bağlantısı kuruldu!');
    };

    socket.onmessage = (event) => {
        const message = JSON.parse(event.data);
        console.log('Mesaj alındı:', message);

        if (message.offer) {
            handleOffer(message.offer);
        } else if (message.answer) {
            handleAnswer(message.answer);
        } else if (message.iceCandidate) {
            handleIceCandidate(message.iceCandidate);
        }
    };

    function checkPassword() {
        const password = document.getElementById("passwordInput").value;
        if (password === "esma5685" || password === "mirhan5685") {
            passwordScreen.style.display = "none";
            start();
            document.getElementById('callButton').disabled = false;
        } else {
            alert("Yanlış şifre, tekrar deneyin!");
        }
    }

    // Kamera akışını başlat
    function start() {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                localVideo.srcObject = stream;
            })
            .catch(error => {
                console.error('Kamera veya mikrofon erişimi hatası:', error);
            });
    }

    // WebRTC bağlantısını başlat
    function startCall() {
        peerConnection = new RTCPeerConnection(configuration);

        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });

        peerConnection.ontrack = (event) => {
            remoteStream = event.streams[0];
            remoteVideo.srcObject = remoteStream;
        };

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.send(JSON.stringify({ iceCandidate: event.candidate }));
            }
        };

        peerConnection.createOffer()
            .then(offer => {
                return peerConnection.setLocalDescription(offer);
            })
            .then(() => {
                socket.send(JSON.stringify({ offer: peerConnection.localDescription }));
            })
            .catch(error => {
                console.error('Teklif oluşturulurken hata:', error);
            });
    }

    function handleOffer(offer) {
        peerConnection = new RTCPeerConnection(configuration);
        peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

        peerConnection.createAnswer()
            .then(answer => {
                return peerConnection.setLocalDescription(answer);
            })
            .then(() => {
                socket.send(JSON.stringify({ answer: peerConnection.localDescription }));
            })
            .catch(error => {
                console.error('Cevap oluşturulurken hata:', error);
            });
    }

    function handleIceCandidate(candidate) {
        peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
            .catch(error => {
                console.error('ICE aday eklenirken hata:', error);
            });
    }
</script>

</body>
</html>
