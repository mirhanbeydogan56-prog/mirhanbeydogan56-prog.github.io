<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC Video & Audio Chat</title>
  <style>
    video {
      width: 300px;
      margin: 10px;
    }
    #remotes {
      display: flex;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <h1>WebRTC Video & Audio Chat</h1>

  <div>
    <label>Room ID: </label>
    <input type="text" id="roomId" value="room1" />
    <button onclick="joinRoom()">Join</button>
  </div>

  <div>
    <h2>Local Video</h2>
    <video id="localVideo" autoplay muted></video>
  </div>

  <div>
    <h2>Remote Videos</h2>
    <div id="remotes"></div>
  </div>

  <script>
    let ws;
    let localStream;
    let peerConnections = {};
    let roomId = document.getElementById("roomId").value;

    // Connect to signaling server
    function connectWS() {
      ws = new WebSocket('ws://localhost:3000');
      ws.onopen = () => console.log('Connected to signaling server');
      ws.onmessage = handleSignalMessage;
    }

    // Start local media (camera and microphone)
    async function startLocalStream() {
      const constraints = {
        audio: true,
        video: true
      };
      localStream = await navigator.mediaDevices.getUserMedia(constraints);
      document.getElementById("localVideo").srcObject = localStream;
    }

    // Join the room
    function joinRoom() {
      roomId = document.getElementById("roomId").value;
      connectWS();
      startLocalStream();
      ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'join', roomId }));
      };
    }

    // Handle signaling messages
    function handleSignalMessage(event) {
      const msg = JSON.parse(event.data);
      if (msg.type === 'new-peer') {
        createPeerConnection();
        createOfferForAll();
      } else if (msg.type === 'signal') {
        const { sdp, candidate } = msg.payload;
        if (sdp) {
          handleSDP(sdp);
        }
        if (candidate) {
          handleICECandidate(candidate);
        }
      }
    }

    // Create a new RTCPeerConnection for a new peer
    function createPeerConnection() {
      const pc = new RTCPeerConnection();
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.onicecandidate = event => {
        if (event.candidate) {
          sendSignal({ candidate: event.candidate });
        }
      };

      pc.ontrack = event => {
        const remoteVideo = document.createElement('video');
        remoteVideo.srcObject = event.streams[0];
        remoteVideo.autoplay = true;
        remoteVideo.playsInline = true;
        document.getElementById("remotes").appendChild(remoteVideo);
      };

      const peerId = Math.random().toString(36).slice(2);
      peerConnections[peerId] = pc;
      return pc;
    }

    // Create an offer for all peers
    async function createOfferForAll() {
      for (let peerId in peerConnections) {
        const pc = peerConnections[peerId];
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        sendSignal({ sdp: pc.localDescription });
      }
    }

    // Handle incoming SDP (offer/answer)
    async function handleSDP(sdp) {
      for (let peerId in peerConnections) {
        const pc = peerConnections[peerId];
        if (sdp.type === 'offer') {
          await pc.setRemoteDescription(new RTCSessionDescription(sdp));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          sendSignal({ sdp: pc.localDescription });
        } else if (sdp.type === 'answer') {
          await pc.setRemoteDescription(new RTCSessionDescription(sdp));
        }
      }
    }

    // Handle incoming ICE candidates
    function handleICECandidate(candidate) {
      for (let peerId in peerConnections) {
        const pc = peerConnections[peerId];
        pc.addIceCandidate(new RTCIceCandidate(candidate));
      }
    }

    // Send signaling messages to WebSocket server
    function sendSignal(payload) {
      ws.send(JSON.stringify({ type: 'signal', roomId, payload }));
    }
  </script>
</body>
</html>
