<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC Video Chat</title>
  <style>
    video { width: 400px; border: 1px solid #333; margin: 10px; }
  </style>
</head>
<body>

<h2>WebRTC Video Chat</h2>

<label>Oda Adı (ör: mirhan5685): </label>
<input id="roomInput" value="mirhan5685">
<button onclick="joinRoom()">Join Room</button>

<br><br>

<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>

<script>
let localVideo = document.getElementById("localVideo");
let remoteVideo = document.getElementById("remoteVideo");

let pc;
let ws;
let room;

// --------------- LOCAL VIDEO ---------------
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
.then(stream => {
    localVideo.srcObject = stream;
    window.localStream = stream;
});

// --------------- JOIN ROOM ---------------
function joinRoom() {
  room = document.getElementById("roomInput").value;
  ws = new WebSocket("ws://localhost:3000");

  ws.onopen = () => {
    ws.send(JSON.stringify({ type: "join", room }));
  };

  ws.onmessage = async (msg) => {
    let data = JSON.parse(msg.data);

    if (data.type === "new-peer") {
      createPeerConnection();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      ws.send(JSON.stringify({ type: "signal", room, payload: { sdp: offer }}));
    }

    if (data.type === "signal") {
      let payload = data.payload;

      if (payload.sdp) {
        if (!pc) createPeerConnection();

        await pc.setRemoteDescription(payload.sdp);

        if (payload.sdp.type === "offer") {
          let answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: "signal", room, payload: { sdp: answer }}));
        }
      }

      if (payload.candidate) {
        pc.addIceCandidate(payload.candidate);
      }
    }
  };
}

// --------------- PEER CONNECTION ---------------
function createPeerConnection() {
  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  // local tracks
  window.localStream.getTracks().forEach(track => pc.addTrack(track, window.localStream));

  // remote tracks
  pc.ontrack = (e) => {
    remoteVideo.srcObject = e.streams[0];
  };

  pc.onicecandidate = (e) => {
    if (e.candidate) {
      ws.send(JSON.stringify({
        type: "signal",
        room,
        payload: { candidate: e.candidate }
      }));
    }
  };
}
</script>

</body>
</html>
